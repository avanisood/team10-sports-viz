<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankey Diagram - D3.js</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2C3E50;
        }
        .node rect {
            cursor: move;
            fill-opacity: 0.9;
            shape-rendering: crispEdges;
        }
        .node text {
            pointer-events: none;
            text-shadow: 0 1px 0 #fff;
            font-size: 14px;
            font-weight: bold;
        }
        .link {
            fill: none;
            stroke-opacity: 0.4;
        }
        .link:hover {
            stroke-opacity: 0.7;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sports Query Intent Analysis - Sankey Diagram</h1>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
            Flow visualization showing how 520 user queries across 4 sports map to different intent categories
        </p>
        <div id="chart"></div>
    </div>
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        const margin = {top: 60, right: 320, bottom: 60, left: 200};
        const width = 1300 - margin.left - margin.right;
        const height = 700 - margin.top - margin.bottom;
        
        const svg = d3.select('#chart')
            .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        const tooltip = d3.select('#tooltip');
        
        // Load and process data
        d3.csv('clean_sports_data.csv').then(data => {
            // Classify intent
            function classifyIntent(text) {
                const lower = text.toLowerCase();
                if (lower.includes('who') || lower.includes('player')) return 'Who (People)';
                if (lower.includes('how') || lower.includes('rule')) return 'How (Rules)';
                if (lower.includes('when') || lower.includes('date') || lower.includes('score')) return 'When/What (Facts)';
                return 'General';
            }
            
            // Count flows
            const flows = {};
            data.forEach(d => {
                const key = `${d.Matched_Keyword}→${classifyIntent(d.Prompt_Text)}`;
                flows[key] = (flows[key] || 0) + 1;
            });
            
            // Build graph structure
            const sports = [...new Set(data.map(d => d.Matched_Keyword))];
            const intents = ['Who (People)', 'How (Rules)', 'When/What (Facts)', 'General'];
            
            const nodes = [
                ...sports.map(name => ({name, type: 'sport'})),
                ...intents.map(name => ({name, type: 'intent'}))
            ];
            
            const links = [];
            Object.keys(flows).forEach(key => {
                const [source, target] = key.split('→');
                links.push({
                    source: nodes.findIndex(n => n.name === source),
                    target: nodes.findIndex(n => n.name === target),
                    value: flows[key]
                });
            });
            
            // Create Sankey generator
            const sankey = d3.sankey()
                .nodeId(d => d.index)
                .nodeWidth(20)
                .nodePadding(20)
                .extent([[0, 0], [width, height]]);
            
            const {nodes: sankeyNodes, links: sankeyLinks} = sankey({
                nodes: nodes.map((d, i) => Object.assign({}, d, {index: i})),
                links: links.map(d => Object.assign({}, d))
            });
            
            // Color scale
            const colorScale = d3.scaleOrdinal()
                .domain(sports)
                .range(['#FF6347', '#87CEEB', '#90EE90', '#FFA500']);
            
            // Draw links
            svg.append('g')
                .selectAll('path')
                .data(sankeyLinks)
                .enter().append('path')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr('stroke-width', d => Math.max(1, d.width))
                .style('stroke', d => colorScale(sankeyNodes[d.source.index].name))
                .style('fill', 'none')
                .style('stroke-opacity', 0.4)
                .on('mouseover', function(event, d) {
                    d3.select(this).style('stroke-opacity', 0.7);
                    tooltip.style('opacity', 1)
                        .html(`${sankeyNodes[d.source.index].name} → ${sankeyNodes[d.target.index].name}<br/>Count: ${d.value}`);
                })
                .on('mousemove', function(event) {
                    tooltip.style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).style('stroke-opacity', 0.4);
                    tooltip.style('opacity', 0);
                });
            
            // Draw nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(sankeyNodes)
                .enter().append('g');
            
            node.append('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .style('fill', d => d.type === 'sport' ? colorScale(d.name) : '#3498db')
                .style('stroke', '#fff')
                .style('stroke-width', 2);
            
            node.append('text')
                .attr('x', d => d.x0 < width / 2 ? d.x0 - 6 : d.x1 + 6)
                .attr('y', d => (d.y0 + d.y1) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.x0 < width / 2 ? 'end' : 'start')
                .text(d => d.name);
            
            // Add legend for sports (positioned far right to avoid overlap)
            const legend = svg.append('g')
                .attr('transform', `translate(${width + 150}, 50)`);
            
            legend.append('text')
                .attr('x', 0)
                .attr('y', -20)
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Sports:');
            
            sports.forEach((sport, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${i * 25})`);
                
                legendRow.append('rect')
                    .attr('width', 15)
                    .attr('height', 15)
                    .style('fill', colorScale(sport));
                
                legendRow.append('text')
                    .attr('x', 20)
                    .attr('y', 12)
                    .text(sport)
                    .style('font-size', '12px');
            });
            
            // Add intent category legend
            legend.append('text')
                .attr('x', 0)
                .attr('y', 120)
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .text('Intent Categories:');
            
            intents.forEach((intent, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${145 + i * 25})`);
                
                legendRow.append('rect')
                    .attr('width', 15)
                    .attr('height', 15)
                    .style('fill', '#3498db');
                
                legendRow.append('text')
                    .attr('x', 20)
                    .attr('y', 12)
                    .text(intent)
                    .style('font-size', '12px');
            });
            
            // Add source and target labels
            svg.append('text')
                .attr('x', -20)
                .attr('y', -30)
                .style('font-size', '16px')
                .style('font-weight', 'bold')
                .style('fill', '#2C3E50')
                .text('SOURCE (Sports)');
            
            svg.append('text')
                .attr('x', width - 130)
                .attr('y', -30)
                .style('font-size', '16px')
                .style('font-weight', 'bold')
                .style('fill', '#2C3E50')
                .text('TARGET (Intent Types)');
        });
    </script>
</body>
</html>
